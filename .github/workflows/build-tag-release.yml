name: Build, Tag and Release
on:
  push:
    branches:
      - release

permissions:
  pull-requests: write
  contents: write

jobs:
  check-status:
    name: Check Status
    runs-on: ubuntu-latest
    outputs:
      is-plugin-update: ${{ steps.set-outputs.outputs.is-plugin-update }}
    steps:
      - uses: actions/checkout@v4
      - id: get-changed-files
        uses: jitterbit/get-changed-files@v1
      - id: set-outputs
        shell: bash
        run: |
          echo "Changed files: ${{ steps.get-changed-files.outputs.all }}"
          shopt -s extglob nocasematch
          run_plugin_update="false"
          for file in ${{ steps.get-changed-files.outputs.all }}; do
            echo "Checking if file '$file' should trigger a plugin release"
            if 
              [[ "$file" != */.wordpress.org/+(*) ]] && \
              [[ "$file" != */.github/+(*) ]] && \
              [[ "$file" != */readme.* ]] && \ 
              [[ "$file" != */".gitattributes" ]] && \
              [[ "$file" != */".gitignore" ]] && \
              [[ "$file" != */"catalog-info.yml" ]] && \
              [[ "$file" != *composer* ]]; then
                echo "'$file' is not an ignored file."
                run_plugin_update="true"
                break
            fi
          done
          echo "::set-output name=is-plugin-update::$run_plugin_update"
  asset-only:
    name: WP.org Asset Only Update
    needs: check-status
    if: ${{ needs.check-status.outputs.is-plugin-update == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: WP.org Asset Only Update
        uses: 10up/action-wordpress-plugin-asset-update@stable
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
  tag:
    needs: check-status
    if: ${{ needs.check-status.outputs.is-plugin-update == 'true' }}
    name: Create Tag and Draft Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build, Tag & Release
        uses: pantheon-systems/plugin-release-actions/build-tag-release@main
        with:
          gh_token: ${{ github.token }}
          readme_md: README.md
